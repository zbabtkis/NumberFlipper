(function(e){"use strict";var t=e.NumberFlipperEl,i=function(e,s){this.el=e,this.mf=s,this._domLayers=[],e.addClass("flipper"),this.increase=t.bind(this.increase,this),this.decrease=t.bind(this.decrease,this),this._events={},this.index=0,this.setLayer(i.Layers.FLIP,this.createTile(0)).show()};i.RAM=function(){function e(){i.RAM.state=i.RAM.state||0,setTimeout(function(){var e=[].slice.call(arguments,0);e.push(i.RAM.state),cb.apply(window,e),i.RAM.state+=1e3/60},1e3/60)}switch(!0){case!!window.requestAnimationFrame:window.requestAnimationFrame.apply(window,arguments);break;case!!window.webkitRequestAnimationFrame:window.webkitRequestAnimationFrame.apply(window,arguments);break;case!!window.mozRequestAnimationFrame:window.webkitRequestAnimationFrame.apply(window,arguments);break;case!!window.oRequestAnimationFrame:window.webkitRequestAnimationFrame.apply(window,arguments);break;default:e.apply(window,arguments)}},i.RAM=i.RAM||function(){},i.FlipRange=function(e,t){for(var i=[],s=e;t>=s;s++)i.push(s);return i},i.ProgressiveAccelleration=function(){this.speed=1},i.ProgressiveAccelleration.prototype.tick=function(){return this},i.ProgressiveAccelleration.prototype.getSpeed=function(){return this.speed},i.Direction={},i.Layers={},i.Classes={},i.Sets={},i.Direction.UP=1,i.Direction.DOWN=-1,i.Layers.MASK_ABOVE=400,i.Layers.FLIP=300,i.Layers.MASK_BELOW=200,i.Layers.NEXT=100,i.Layers.LAST=101,i.Classes[i.Layers.MASK_ABOVE]="mask",i.Classes[i.Layers.MASK_BELOW]="mask",i.Sets.SingleDigit=i.FlipRange(0,9),i.prototype.getIndex=function(){return this.index},i.prototype.setIndex=function(e){this.index=e},i.prototype.increase=function(){var e=this.index+1>=this.mf.length?0:this.index+1;this.setIndex(e)},i.prototype.decrease=function(){var e=this.index-1<=0?this.mf.length-1:this.index-1;this.setIndex(e)},i.prototype.transitionNumbers=function(e,t){var i=this.getIndex(),s=this.getIndex(e());return 0===s&&i>s&&this.trigger("loop"),{current:this.mf[i],after:this.mf[s],speed:t}},i.prototype.createTile=function(e){var i=t(document.createElement("div"));return i.addClass("tile-inner"),i.text(e),i},i.prototype.createHalfTile=function(e){return this.createTile(e).addClass("mask-inner")},i.prototype.setLayer=function(e,s){return this._domLayers[e]&&(this._domLayers[e].remove(),this._domLayers[e]=null),s?(this._domLayers[e]=t(document.createElement("div")),this._domLayers[e].hide().append(s).css("z-index",e).addClass("tile").addClass(i.Classes[e]).appendTo(this.el),this._domLayers[e]):this},i.prototype.getLayer=function(e){return this._domLayers[e]},i.prototype.setupFlip=function(e){this.flipAccelleration=new i.ProgressiveAccelleration,this.setLayer(i.Layers.FLIP,this.createTile(e.current)).show(),this.setLayer(i.Layers.NEXT,this.createTile(e.after)).show(),this.setLayer(i.Layers.MASK_ABOVE,this.createHalfTile(e.current)).addClass("below").show(),this.setLayer(i.Layers.MASK_BELOW,this.createHalfTile(e.current)).addClass("below").show()},i.prototype.flipAway=function(e,s,r,n){var a,s=s||t.Deferred(),o=this.flipAccelleration.getSpeed();if(!n)return i.RAM(t.bind(this.flipAway,this,e,s,null)),s.promise();r=r||n,a=n-r;var p=this.normalRotation(a,e.speed+o,1,-90),l=this.getLayer(i.Layers.FLIP);return p=p>=-90?p:-90,this.rotateDomElement(l.children[0],p),this.flipAccelleration.tick(a),-90===p?s.resolve():void i.RAM(t.bind(this.flipAway,this,e,s,r))},i.prototype.setupFinalFlip=function(e){this.setLayer(i.Layers.MASK_ABOVE,this.createHalfTile(e.after)).addClass("above").show(),this.setLayer(i.Layers.FLIP,this.createTile(e.after))},i.prototype.flipIn=function(e,s,r,n){var a,s=s||t.Deferred(),o=this.flipAccelleration.getSpeed();if(!n)return i.RAM(t.bind(this.flipIn,this,e,s,null)),s.promise();r=r||n,a=n-r;var p=90-this.normalRotation(a,e.speed+o,1,90),l=this.getLayer(i.Layers.FLIP);return p=p>0?p:0,this.rotateDomElement(l.children[0],p),this.flipAccelleration.tick(a),l.show(),0===p?s.resolve(n):void i.RAM(t.bind(this.flipIn,this,e,s,r))},i.prototype.teardown=function(){this.setLayer(i.Layers.MASK_ABOVE,null),this.setLayer(i.Layers.FLIP,null),this.setLayer(i.Layers.NEXT,null),this.setLayer(i.Layers.MASK_BELOW,null)},i.prototype.rotateDomElement=function(e,i){t(e).css("-webkit-transform","rotateX("+i+"deg)")},i.prototype.normalRotation=function(e,t,i,s){return parseInt(e/1e3*t*s/i)},i.prototype.warpSpeed=function(e,t){return Math.pow(t/2-Math.abs(e-t/2)+1,1.25)},i.prototype.run=function(e,t,i){var i,s,r=this;i&&i.flip&&i.flip.speed?s=this.transitionNumbers(e,i.flip.speed):(i=i||1,s=this.transitionNumbers(e,this.warpSpeed(i,t))),this.flip=s,this.setupFlip(s),this.flipAway(s).then(function(){r.setupFinalFlip(s),r.flipIn(s).then(function(){t>i&&(r.teardown(),r.run(e,t,i+1))})})},i.prototype.on=function(e,t){this._events[e]=this._events[e]||[],this._events[e].push(t)},i.prototype.trigger=function(e,i){this._events[e]=this._events[e]||[],t.each(this._events[e],function(e){e(i)})};var s=function(e,s){var r,r,n,a=[];e=t(e),e.addClass("multiflip");for(var o=0;s>o;o++){var p=65*s-65*o-65;n=t(document.createElement("div")),n.css("left",p+"px"),r=new i(n,i.Sets.SingleDigit),a.push(r),n.appendTo(e),a[o-1]&&a[o-1].on("loop",t.bind(r.run,r,r.increase,1,a[o-1]))}this.digits=s,this.currentNumber=0,this.flippers=a};s.prototype.run=function(e){this.flipTo(this.flippers[0],e)},s.prototype.flipTo=function(e,t){var i=t-this.currentNumber;0>i&&(i=Math.pow(10,this.digits)+i),i&&(this.currentNumber=t,e.run(e.increase,Math.abs(i)))},s.Flipper=i,e.NumberFlipper=s}).call(this,this);